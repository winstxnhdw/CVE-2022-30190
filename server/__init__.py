from cgi import parse_header, parse_multipart
from http.server import HTTPServer, SimpleHTTPRequestHandler


class Server(SimpleHTTPRequestHandler):

    def do_POST(self):

        print(f"\n{self.headers}", end="")

        pdict = parse_header(self.headers['Content-Type'])[1]
        pdict['boundary'] = bytes(pdict['boundary'], 'utf-8')
        multipart_dict = parse_multipart(self.rfile, pdict)

        with open(f"{multipart_dict['ip'][0]}.zip", 'wb') as f:
            f.write(multipart_dict['file'][0])

        self.send_response(404)
        self.end_headers()


def init_server(host: str, port: int):

    httpd = HTTPServer((host, port), Server)

    try:
        print(f"Serving HTTP on {host} port {port} (http://{host}:{port}/)..")
        httpd.serve_forever()

    except KeyboardInterrupt:
        print("Manual exit detected.")

    finally:
        httpd.server_close()
        print("\nServer closing..")